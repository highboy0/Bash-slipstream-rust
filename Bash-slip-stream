#!/bin/bash

set -e

# نصب پیش‌نیازها
if ! command -v whiptail &> /dev/null || ! command -v jq &> /dev/null; then
    apt update && apt install -y whiptail curl jq openssl
fi

CONFIG_DIR="/opt/slipstream"
CONFIG_FILE="$CONFIG_DIR/config.ini"
BIN_DIR="$CONFIG_DIR"
SERVER_BIN="$BIN_DIR/slipstream-server"
CLIENT_BIN="$BIN_DIR/slipstream-client"
CERT_FILE="$CONFIG_DIR/cert.pem"
KEY_FILE="$CONFIG_DIR/key.pem"

HEIGHT=20
WIDTH=78
MENU_HEIGHT=12

# دانلود باینری‌ها
download_binaries() {
    mkdir -p "$CONFIG_DIR"
    cd "$CONFIG_DIR"

    if whiptail --title "دانلود باینری" --yesno "آخرین نسخه Slipstream را دانلود کنیم؟" $HEIGHT $WIDTH; then
        whiptail --title "در حال دانلود" --infobox "در حال دریافت آخرین نسخه..." $HEIGHT $WIDTH
        LATEST=$(curl -s https://github.com/highboy0/Bash-slipstream-rust/blob/main/sliprstream.tar.gz | jq -r '.tag_name')
        ASSET_URL=$(curl -s https://github.com/highboy0/Bash-slipstream-rust/blob/main/sliprstream.tar.gz | jq -r '.assets[] | select(.name | contains("linux-amd64")) | .browser_download_url')

        if [[ -z "$ASSET_URL" ]]; then
            whiptail --title "خطا" --msgbox "باینری linux-amd64 پیدا نشد.\nلطفاً دستی دانلود کنید." $HEIGHT $WIDTH
            exit 1
        fi

        curl -L -o slipstream.tar.gz "$ASSET_URL"
        tar -xzf slipstream.tar.gz --strip-components=0
        rm slipstream.tar.gz
        chmod +x slipstream-server slipstream-client
        whiptail --title "موفقیت" --msgbox "دانلود و استخراج با موفقیت انجام شد." $HEIGHT $WIDTH
    fi
}

# ساخت گواهی
generate_cert() {
    local domain=$1
    whiptail --title "گواهی SSL" --infobox "در حال ساخت گواهی self-signed برای $domain..." $HEIGHT $WIDTH
    openssl req -x509 -newkey rsa:2048 -nodes \
        -keyout "$KEY_FILE" -out "$CERT_FILE" -days 365 \
        -subj "/CN=$domain" >/dev/null 2>&1
}

# آزاد کردن پورت 53
free_port_53() {
    systemctl stop systemd-resolved >/dev/null 2>&1 || true
    systemctl disable systemd-resolved >/dev/null 2>&1 || true
}

# ساخت/به‌روزرسانی سرویس systemd
create_service() {
    local type=$1
    local service_name="slipstream-$type"
    local service_file="/etc/systemd/system/$service_name.service"

    if [[ "$type" == "server" ]]; then
        cat > "$service_file" <<EOF
[Unit]
Description=Slipstream Server (DNS Tunnel)
After=network.target

[Service]
Type=simple
WorkingDirectory=$CONFIG_DIR
ExecStart=$SERVER_BIN \\
  --dns-listen-port 53 \\
  --target-address 127.0.0.1:$(jq -r '.inbound_port' "$CONFIG_FILE") \\
  --domain $(jq -r '.domain' "$CONFIG_FILE") \\
  --cert $CERT_FILE \\
  --key $KEY_FILE
Restart=always
RestartSec=5
User=root
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF
    else
        local resolvers=$(jq -r '.resolvers[]' "$CONFIG_FILE" | sed 's/^/--resolver /' | paste -sd " " -)
        cat > "$service_file" <<EOF
[Unit]
Description=Slipstream Client (Fragment)
After=network.target

[Service]
Type=simple
WorkingDirectory=$CONFIG_DIR
ExecStart=$CLIENT_BIN \\
  --tcp-listen-port $(jq -r '.listen_port' "$CONFIG_FILE") \\
  $resolvers \\
  --domain $(jq -r '.domain' "$CONFIG_FILE")
Restart=always
RestartSec=5
User=root
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF
    fi

    systemctl daemon-reload
    systemctl enable "$service_name.service" >/dev/null
    systemctl restart "$service_name.service" >/dev/null
    whiptail --title "موفقیت" --msgbox "سرویس $service_name با موفقیت به‌روزرسانی و ری‌استارت شد." $HEIGHT $WIDTH
}

# منوی اصلی
main_menu() {
    while true; do
        CHOICE=$(whiptail --title "مدیریت Slipstream" --menu "گزینه مورد نظر را انتخاب کنید:" $HEIGHT $WIDTH $MENU_HEIGHT \
            "1" "راه‌اندازی اولیه" \
            "2" "تغییر تنظیمات" \
            "3" "مدیریت Resolverها (فقط کلاینت)" \
            "4" "نمایش وضعیت سرویس" \
            "5" "حذف کامل Slipstream" \
            "6" "خروج" 3>&1 1>&2 2>&3)

        case $CHOICE in
            1) initial_setup ;;
            2) edit_settings ;;
            3) manage_resolvers ;;
            4) show_status ;;
            5) uninstall ;;
            6) exit 0 ;;
            *) whiptail --title "خطا" --msgbox "انتخاب نامعتبر!" $HEIGHT $WIDTH ;;
        esac
    done
}

# وضعیت سرویس
show_status() {
    if [[ -f "$CONFIG_FILE" ]]; then
        type=$(jq -r '.type' "$CONFIG_FILE")
        status=$(systemctl status "slipstream-$type.service" --no-pager -l | cat)
        whiptail --title "وضعیت سرویس slipstream-$type" --scrolltext --msgbox "$status" $HEIGHT $WIDTH
    else
        whiptail --title "خطا" --msgbox "هنوز راه‌اندازی اولیه انجام نشده است." $HEIGHT $WIDTH
    fi
}

# راه‌اندازی اولیه
initial_setup() {
    if [[ -f "$CONFIG_FILE" ]]; then
        if ! whiptail --title "هشدار" --yesno "راه‌اندازی اولیه قبلاً انجام شده. دوباره انجام شود؟ (فایل‌ها بازنویسی می‌شوند)" $HEIGHT $WIDTH; then
            return
        fi
    fi

    SERVER_TYPE=$(whiptail --title "نوع سرور" --menu "در کدام سرور هستید؟" $HEIGHT $WIDTH 3 \
        "kharej" "سرور خارج (Server)" \
        "iran"  "سرور ایران (Client)" 3>&1 1>&2 2>&3)

    download_binaries

    DOMAIN=$(whiptail --title "دامنه" --inputbox "دامنه NS را وارد کنید (مثل ns.xraychannel.com):" $HEIGHT $WIDTH "ns.xraychannel.com" 3>&1 1>&2 2>&3)

    if [[ "$SERVER_TYPE" == "kharej" ]]; then
        INBOUND_PORT=$(whiptail --title "پورت inbound" --inputbox "پورت inbound مرزبان (localhost):" $HEIGHT $WIDTH "10000" 3>&1 1>&2 2>&3)
        generate_cert "$DOMAIN"
        free_port_53

        cat > "$CONFIG_FILE" <<EOF
{
    "type": "server",
    "domain": "$DOMAIN",
    "inbound_port": "$INBOUND_PORT"
}
EOF
        create_service server
    else
        LISTEN_PORT=$(whiptail --title "پورت listen" --inputbox "پورت listen کلاینت (مثل 443):" $HEIGHT $WIDTH "443" 3>&1 1>&2 2>&3)

        RESOLVERS=()
        while true; do
            RES=$(whiptail --title "Resolverها" --inputbox "Resolver اضافه کنید (مثل 8.8.8.8:53)\nبرای پایان خالی بگذارید:" $HEIGHT $WIDTH 3>&1 1>&2 2>&3) || break
            [[ -z "$RES" ]] && break
            RESOLVERS+=("\"$RES\"")
        done

        if [[ ${#RESOLVERS[@]} -eq 0 ]]; then
            whiptail --title "خطا" --msgbox "حداقل یک resolver لازم است!" $HEIGHT $WIDTH
            return
        fi

        cat > "$CONFIG_FILE" <<EOF
{
    "type": "client",
    "domain": "$DOMAIN",
    "listen_port": "$LISTEN_PORT",
    "resolvers": [\( (IFS=,; echo " \){RESOLVERS[*]}")]
}
EOF
        create_service client
    fi

    whiptail --title "موفقیت" --msgbox "راه‌اندازی اولیه با موفقیت انجام شد!" $HEIGHT $WIDTH
}

# تغییر تنظیمات
edit_settings() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        whiptail --title "خطا" --msgbox "ابتدا راه‌اندازی اولیه را انجام دهید." $HEIGHT $WIDTH
        return
    fi

    CURRENT_DOMAIN=$(jq -r '.domain' "$CONFIG_FILE")

    if jq -e '.type == "server"' "$CONFIG_FILE" >/dev/null; then
        CURRENT_PORT=$(jq -r '.inbound_port' "$CONFIG_FILE")
        NEW_DOMAIN=$(whiptail --title "دامنه جدید" --inputbox "دامنه جدید (فعلی: $CURRENT_DOMAIN):" $HEIGHT $WIDTH "$CURRENT_DOMAIN" 3>&1 1>&2 2>&3)
        NEW_PORT=$(whiptail --title "پورت inbound" --inputbox "پورت inbound جدید (فعلی: $CURRENT_PORT):" $HEIGHT $WIDTH "$CURRENT_PORT" 3>&1 1>&2 2>&3)

        jq ".domain = \"$NEW_DOMAIN\" | .inbound_port = \"$NEW_PORT\"" "\( CONFIG_FILE" > " \){CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        generate_cert "$NEW_DOMAIN"
        create_service server
    else
        CURRENT_PORT=$(jq -r '.listen_port' "$CONFIG_FILE")
        NEW_DOMAIN=$(whiptail --title "دامنه جدید" --inputbox "دامنه جدید (فعلی: $CURRENT_DOMAIN):" $HEIGHT $WIDTH "$CURRENT_DOMAIN" 3>&1 1>&2 2>&3)
        NEW_PORT=$(whiptail --title "پورت listen" --inputbox "پورت listen جدید (فعلی: $CURRENT_PORT):" $HEIGHT $WIDTH "$CURRENT_PORT" 3>&1 1>&2 2>&3)

        jq ".domain = \"$NEW_DOMAIN\" | .listen_port = \"$NEW_PORT\"" "\( CONFIG_FILE" > " \){CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        create_service client
    fi

    whiptail --title "موفقیت" --msgbox "تنظیمات با موفقیت به‌روزرسانی شد." $HEIGHT $WIDTH
}

# مدیریت resolverها
manage_resolvers() {
    if [[ ! -f "$CONFIG_FILE" ]] || jq -e '.type != "client"' "$CONFIG_FILE" >/dev/null; then
        whiptail --title "خطا" --msgbox "این گزینه فقط برای سرور ایران (کلاینت) است." $HEIGHT $WIDTH
        return
    fi

    CURRENT=$(jq -r '.resolvers[]' "$CONFIG_FILE" | paste -sd ", " -)

    CHOICE=$(whiptail --title "مدیریت Resolverها" --menu "Resolverهای فعلی: $CURRENT\nانتخاب کنید:" $HEIGHT $WIDTH 4 \
        "1" "اضافه کردن Resolver" \
        "2" "حذف Resolver" 3>&1 1>&2 2>&3)

    case $CHOICE in
        1)
            NEW_RES=$(whiptail --title "اضافه کردن" --inputbox "Resolver جدید (مثل 8.8.8.8:53):" $HEIGHT $WIDTH 3>&1 1>&2 2>&3)
            jq ".resolvers += [\"$NEW_RES\"]" "\( CONFIG_FILE" > " \){CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            ;;
        2)
            DEL_RES=$(whiptail --title "حذف" --inputbox "Resolver برای حذف:" $HEIGHT $WIDTH 3>&1 1>&2 2>&3)
            jq ".resolvers |= . - [\"$DEL_RES\"]" "\( CONFIG_FILE" > " \){CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            ;;
    esac

    create_service client
    whiptail --title "موفقیت" --msgbox "Resolverها به‌روزرسانی شد." $HEIGHT $WIDTH
}

# حذف کامل
uninstall() {
    if ! whiptail --title "تأیید حذف" --yesno "آیا مطمئن هستید که می‌خواهید Slipstream را کامل حذف کنید؟ (سرویس، فایل‌ها و config)" $HEIGHT $WIDTH; then
        return
    fi

    if [[ -f "$CONFIG_FILE" ]]; then
        type=$(jq -r '.type' "$CONFIG_FILE")
        systemctl stop "slipstream-$type.service" >/dev/null 2>&1 || true
        systemctl disable "slipstream-$type.service" >/dev/null 2>&1 || true
        rm -f "/etc/systemd/system/slipstream-$type.service"
    fi

    rm -rf "$CONFIG_DIR"
    systemctl daemon-reload
    whiptail --title "موفقیت" --msgbox "Slipstream با موفقیت حذف شد." $HEIGHT $WIDTH
}

# شروع
whiptail --title "خوش آمدید" --msgbox "به اسکریپت مدیریت Slipstream با رابط گرافیکی خوش آمدید!\nاین اسکریپت تمام مراحل را به صورت تعاملی انجام می‌دهد." $HEIGHT $WIDTH
main_menu
